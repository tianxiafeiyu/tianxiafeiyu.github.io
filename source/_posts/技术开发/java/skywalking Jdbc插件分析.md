---
title: skywalking Jdbc插件分析
date: 2022-12-15 23:39:56
updated: 2022-12-16 21:36:16
toc: true
tags: 
    - skywalking Jdbc插件分析
---

## mysql-8.x-plugin
<table>
   <tr>
      <td>拦截形式</td>
      <td>增强的类</td>
      <td>增强方法</td>
      <td>类型</td>
      <td>方法说明</td>
      <td>拦截器</td>
      <td>执行前</td>
      <td>执行后</td>
      <td>报错</td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.CallableInstrumentation</td>
      <td>com.mysql.cj.jdbc.CallableStatement</td>
      <td>execute、executeQuery、executeUpdate</td>
      <td>实例方法</td>
      <td>调用存储过程类增强，拦截存储过程的执行方法</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.PreparedStatementExecuteMethodsInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>ContextManager.stopSpan()，结束追踪</td>
      <td>ContextManager.activeSpan().errorOccurred().log(t)，记录异常堆栈</td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.ConnectionImplCreateInstrumentation</td>
      <td>com.mysql.cj.jdbc.ConnectionImpl</td>
      <td>getInstance</td>
      <td>静态方法</td>
      <td>拦截获取数据库连接方法</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.ConnectionCreateInterceptor</td>
      <td></td>
      <td>记录数据库连接信息connectionInfo (dbType,dbName,dbPeer...)</td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.ConnectionInstrumentation</td>
      <td>com.mysql.cj.jdbc.ConnectionImpl</td>
      <td>prepareStatement</td>
      <td>实例方法</td>
      <td>创建一个PreparedStatement对象，该对象用于预编译和发送sql,获得执行结果</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.CreatePreparedStatementInterceptor</td>
      <td></td>
      <td>记录statement信息StatementEnhanceInfos（connectionInfo,statementName,sql...）</td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.ConnectionInstrumentation</td>
      <td>com.mysql.cj.jdbc.ConnectionImpl</td>
      <td>prepareCall</td>
      <td>实例方法</td>
      <td>创建一个CallableStatement。此对象用于调用数据库存储过程</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.CreateCallableStatementInterceptor</td>
      <td></td>
      <td>记录statement信息StatementEnhanceInfos（connectionInfo,statementName,sql...）</td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.ConnectionInstrumentation</td>
      <td>com.mysql.cj.jdbc.ConnectionImpl</td>
      <td>createStatement,参数数量为2</td>
      <td>实例方法</td>
      <td>创建一个Statement对象，Statement用于发送sql语句到数据库和获得返回结果</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.CreateStatementInterceptor</td>
      <td></td>
      <td>记录statement信息StatementEnhanceInfos（connectionInfo,statementName...）</td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.ConnectionInstrumentation</td>
      <td>com.mysql.cj.jdbc.ConnectionImpl</td>
      <td>commit、rollback、close、releaseSavepoint</td>
      <td>实例方法</td>
      <td>事务相关操作</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.ConnectionServiceMethodInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>ContextManager.stopSpan()，结束追踪</td>
      <td>ContextManager.activeSpan().errorOccurred().log(t)，记录异常堆栈</td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.ConnectionInstrumentation</td>
      <td>com.mysql.cj.jdbc.ConnectionImpl</td>
      <td>setCatalog</td>
      <td>实例方法</td>
      <td>设置给定目录名称，以便选择要在其中进行工作的此 Connection 对象数据库的子空间</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.SetCatalogInterceptor</td>
      <td>获取connectionInfo，调用setDatabaseName(),记录目录名称catalog</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.PreparedStatementInstrumentation</td>
      <td>com.mysql.cj.jdbc.ClientPreparedStatement、com.mysql.cj.jdbc.ServerPreparedStatement</td>
      <td>execute、executeQuery、executeUpdate、executeLargeUpdate</td>
      <td>实例方法</td>
      <td>ClientPreparedStatement是PreparedStatement接口的实现类，StatementImpl的子类；ServerPreparedStatement是ClientPreparedStatement的子类，预编译和发送sql的类</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.PreparedStatementExecuteMethodsInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>ContextManager.stopSpan()，结束追踪</td>
      <td>ContextManager.activeSpan().errorOccurred().log(t)，记录异常堆栈</td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.PreparedStatementIgnoredSetterInstrumentation</td>
      <td>com.mysql.cj.jdbc.ClientPreparedStatement、com.mysql.cj.jdbc.ServerPreparedStatement</td>
      <td>setAsciiStream, setBinaryStream, setBlob, setBytes, setCharacterStream, setClob, setNCharacterStream, setNClob, setRef, setSQLXML, setUnicodeStream</td>
      <td>实例方法</td>
      <td>参数绑定（长文本）</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.JDBCPreparedStatementIgnorableSetterInterceptor</td>
      <td>statementEnhanceInfos.setParameter(index, "?")，记录参数信息，避免数据太大，用”?“代替</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.PreparedStatementNullSetterInstrumentation</td>
      <td>com.mysql.cj.jdbc.ClientPreparedStatement、com.mysql.cj.jdbc.ServerPreparedStatement</td>
      <td>setNull</td>
      <td>实例方法</td>
      <td>参数绑定（null）</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.JDBCPreparedStatementNullSetterInterceptor</td>
      <td>statementEnhanceInfos.setParameter(index, "NULL")，记录参数信息</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.PreparedStatementSetterInstrumentation</td>
      <td>com.mysql.cj.jdbc.ClientPreparedStatement、com.mysql.cj.jdbc.ServerPreparedStatement</td>
      <td>setArray, setBigDecimal, setBoolean, setByte, setDate, setDouble, setFloat, setInt, setLong, setNString, setObject, setRowId, setShort, setString, setTime, setTimestamp, setURL</td>
      <td>实例方法</td>
      <td>参数绑定</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.JDBCPreparedStatementSetterInterceptor</td>
      <td>statementEnhanceInfos.setParameter(index, parameter)，记录参数信息</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.v8.define.StatementInstrumentation</td>
      <td>com.mysql.cj.jdbc.StatementImpl</td>
      <td>execute、executeQuery、executeUpdate、executeLargeUpdate、executeBatchInternal、executeUpdateInternal、executeQuery、executeBatch</td>
      <td>实例方法</td>
      <td>StatementImpl是Statement接口的实现类，用于发送sql命令，获得查询结果。</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.mysql.StatementExecuteMethodsInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>ContextManager.stopSpan()，结束追踪</td>
      <td>ContextManager.activeSpan().errorOccurred().log(t)，记录异常堆栈</td>
   </tr>
   <tr>
      <td></td>
   </tr>
</table>

## postgresql-8.x-plugin

<table>
   <tr>
      <td>拦截形式</td>
      <td>增强的类</td>
      <td>增强方法</td>
      <td>类型</td>
      <td>方法说明</td>
      <td>拦截器</td>
      <td>执行前</td>
      <td>执行后</td>
      <td>报错</td>
   </tr>
   <tr>
      <td>AbstractJdbc2StatementInstrumentation</td>
      <td>org.postgresql.jdbc2.AbstractJdbc2Statement（发行版中该类已废弃）</td>
      <td>无参的execute，executeQuery，executeUpdate</td>
      <td>实例方法</td>
      <td>sql语句执行方法</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.PreparedStatementExecuteMethodsInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>结束追踪</td>
      <td>记录错误堆栈</td>
   </tr>
   <tr>
      <td></td>
      <td></td>
      <td>入参数目为1的execute，executeQuery，executeUpdate</td>
      <td>实例方法</td>
      <td>sql语句执行方法</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.StatementExecuteMethodsInterceptor</td>
      <td>同上</td>
      <td>同上</td>
      <td>同上</td>
   </tr>
   <tr>
      <td>ConnectionInstrumentation</td>
      <td>"org.postgresql.jdbc.PgConnection，</td>
   </tr>
   <tr>
      <td>org.postgresql.jdbc42.Jdbc42Connection（已废弃），</td>
   </tr>
   <tr>
      <td>org.postgresql.jdbc3g.Jdbc3gConnection（已废弃），</td>
   </tr>
   <tr>
      <td>org.postgresql.jdbc4.Jdbc4Connection（已废弃）</td>
   </tr>
   <tr>
      <td></td>
   </tr>
   <tr>
      <td>"</td>
      <td>入参数目为4的prepareStatement</td>
      <td>实例方法</td>
      <td>创建一个PgPreparedStatement对象，该对象用于预编译和发送sql,获得执行结果</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.CreatePreparedStatementInterceptor</td>
      <td></td>
      <td>记录statement信息StatementEnhanceInfos（connectionInfo,statementName,sql...）</td>
      <td></td>
   </tr>
   <tr>
      <td></td>
      <td></td>
      <td>第二个参数类型为String[]的prepareStatement</td>
      <td>实例方法</td>
      <td>同上</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.JDBCPrepareStatementWithStringArrayInterceptor</td>
      <td></td>
      <td>记录statement信息StatementEnhanceInfos（connectionInfo,statementName,sql...）</td>
      <td></td>
   </tr>
   <tr>
      <td></td>
      <td></td>
      <td>入参数目为4的prepareCall</td>
      <td>实例方法</td>
      <td>创建一个CPgCallableStatement。此对象用于调用数据库存储过程</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.CreateCallableStatementInterceptor</td>
      <td></td>
      <td>创建PreparedStatement的代理SWPreparedStatement，记录（connectionInfo,statementName,sql...）</td>
      <td></td>
   </tr>
   <tr>
      <td></td>
      <td></td>
      <td>入参数目为3的createStatement</td>
      <td>实例方法</td>
      <td>创建一个PgStatement，该对象用于预编译和发送sql,获得执行结果</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.CreateStatementInterceptor</td>
      <td></td>
      <td>记录statement信息StatementEnhanceInfos（connectionInfo,statementName,sql...）</td>
      <td></td>
   </tr>
   <tr>
      <td></td>
      <td></td>
      <td>commit,rollback,close,releaseSavepoint</td>
      <td>实例方法</td>
      <td>数据库事务相关方法</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.ConnectionServiceMethodInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>结束追踪</td>
      <td>记录错误堆栈</td>
   </tr>
   <tr>
      <td>Jdbc3ConnectionInstrumentation</td>
      <td>org.postgresql.jdbc3.Jdbc3Connection（已废弃）</td>
      <td>同ConnectionInstrumentation,应该是重复的</td>
      <td>实例方法</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>Jdbc4ConnectionInstrumentation</td>
      <td>org.postgresql.jdbc4.Jdbc4Connection（已废弃）</td>
      <td>同上</td>
      <td>实例方法</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>PgCallableStatementInstrumentation</td>
      <td>org.postgresql.jdbc.PgCallableStatement</td>
      <td>"第一个参数为int的executeWithFlags，</td>
   </tr>
   <tr>
      <td>executeUpdate"</td>
      <td>实例方法</td>
      <td>执行sql方法</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.PreparedStatementExecuteMethodsInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>结束追踪</td>
      <td>记录错误堆栈</td>
   </tr>
   <tr>
      <td>PgPreparedStatementInstrumentation</td>
      <td>org.postgresql.jdbc.PgPreparedStatement</td>
      <td>"第一个参数为string的execute，</td>
   </tr>
   <tr>
      <td>第一个参数为int的executeWithFlags,</td>
   </tr>
   <tr>
      <td>executeQuery,</td>
   </tr>
   <tr>
      <td>executeUpdate</td>
   </tr>
   <tr>
      <td>"</td>
      <td>实例方法</td>
      <td>执行sql方法</td>
      <td>同上</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>结束追踪</td>
      <td>记录错误堆栈</td>
   </tr>
   <tr>
      <td>PgPreparedStatementSetterInstrumentation</td>
      <td>org.postgresql.jdbc.PgPreparedStatement</td>
      <td>setAsciiStream, setBinaryStream, setBlob, setBytes, setCharacterStream, setClob, setNCharacterStream, setNClob, setRef, setSQLXML, setUnicodeStream</td>
      <td>实例方法</td>
      <td>参数绑定（长文本）</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.JDBCPreparedStatementIgnorableSetterInterceptor</td>
      <td>statementEnhanceInfos.setParameter(index, "?")，记录参数信息，避免数据太大，用”?“代替</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>PgStatementInstrumentation</td>
      <td>org.postgresql.jdbc.PgStatement</td>
      <td>"第一个参数为stirng或string[]的execute，</td>
   </tr>
   <tr>
      <td>executeQuery，</td>
   </tr>
   <tr>
      <td>第一个参数为stirng或string[]的executeUpdate，</td>
   </tr>
   <tr>
      <td>executeLargeUpdate，"</td>
      <td>实例方法</td>
      <td>执行sql方法</td>
      <td>org.apache.skywalking.apm.plugin.jdbc.postgresql.StatementExecuteMethodsInterceptor</td>
      <td>创建ExitSpan，追踪本次数据库调用</td>
      <td>结束追踪</td>
      <td>记录错误堆栈</td>
   </tr>
   <tr>
      <td></td>
   </tr>
</table>